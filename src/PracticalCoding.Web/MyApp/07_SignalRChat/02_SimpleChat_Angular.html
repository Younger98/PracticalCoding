<!DOCTYPE html>
<html ng-app="myapp">
<head>
    <title>SignalR Simple Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../../Content/bootstrap.css" rel="stylesheet" />
    <link href="../../Content/font-awesome.css" rel="stylesheet" />
    <style>
        .chat
        {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .chat li
        {
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px dotted #B3A9A9;
        }

        .chat li.left .chat-body
        {
            margin-left: 60px;
        }

        .chat li.right .chat-body
        {
            margin-right: 60px;
        }


        .chat li .chat-body p
        {
            margin: 0;
            color: #777777;
        }

        .panel .slidedown .glyphicon, .chat .glyphicon
        {
            margin-right: 5px;
        }

        .panel-body
        {
            overflow-y: scroll;
            height: 250px;
        }

        ::-webkit-scrollbar-track
        {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
            background-color: #F5F5F5;
        }

        ::-webkit-scrollbar
        {
            width: 12px;
            background-color: #F5F5F5;
        }

        ::-webkit-scrollbar-thumb
        {
            -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
            background-color: #555;
        }

    </style>
    <!--Reference the jQuery library. -->
    <script src="../../Scripts/jquery-1.10.2.js"></script>
    <!--Reference the SignalR library. -->
    <script src="../../Scripts/jquery.signalR-2.1.2.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
    <script src="../../Scripts/angular/angular.js"></script>
    <script src="../../Scripts/angular/ui-bootstrap-tpls-0.12.0.js"></script>
    <script src="../../Scripts/angular/signalr-hub.js"></script>
</head>
<body ng-controller="myappCtrl">
    <br/>
    <div class="container">
        <div class="row">
            <div class="col-md-5">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        <span class="glyphicon glyphicon-comment"></span> SignalR Chat App
                        <div class="btn-group pull-right">
                            <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown">
                                <span class="glyphicon glyphicon-chevron-down"></span>
                            </button>
                            <ul class="dropdown-menu slidedown">
                                <li>
                                    <a href="http://www.jquery2dotnet.com">
                                        <span class="glyphicon glyphicon-refresh">
                                        </span>Refresh
                                    </a>
                                </li>
                                <li>
                                    <a href="http://www.jquery2dotnet.com">
                                        <span class="glyphicon glyphicon-ok-sign">
                                        </span>Available
                                    </a>
                                </li>
                                <li>
                                    <a href="http://www.jquery2dotnet.com">
                                        <span class="glyphicon glyphicon-remove">
                                        </span>Busy
                                    </a>
                                </li>
                                <li>
                                    <a href="http://www.jquery2dotnet.com">
                                        <span class="glyphicon glyphicon-time"></span>
                                        Away
                                    </a>
                                </li>
                                <li class="divider"></li>
                                <li>
                                    <a href="http://www.jquery2dotnet.com">
                                        <span class="glyphicon glyphicon-off"></span>
                                        Sign Out
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="panel-body">
                        <ul class="chat">                            
                            <li ng-repeat="chatMessage in chatMessages" ng-class="!chatMessage.me? 'left clearfix':'right clearfix'">
                                <span ng-class="!chatMessage.me? 'chat-img pull-left':'chat-img pull-right'">
                                    <img src="http://placehold.it/35/55C1E7/fff&text=U" alt="User Avatar" class="img-circle" ng-if="!chatMessage.me" />
                                    <img src="http://placehold.it/35/FA6F57/fff&text=ME" alt="User Avatar" class="img-circle" ng-if="chatMessage.me" />
                                </span>
                                <div class="chat-body clearfix" ng-if="!chatMessage.me">
                                    <div class="header">
                                        <strong class="primary-font">{{chatMessage.name}}</strong>
                                        <small class="pull-right text-muted">
                                            <span class="glyphicon glyphicon-time"></span>{{chatMessage.sendDate | date: 'h:mm:ss a'}}
                                        </small>
                                    </div>
                                    <p>
                                        {{chatMessage.msg}}
                                    </p>
                                </div>

                                <div class="chat-body clearfix" ng-if="chatMessage.me">
                                    <div class="header">
                                        <small class=" text-muted">
                                            <span class="glyphicon glyphicon-time"></span>{{chatMessage.sendDate | date: 'h:mm:ss a'}}
                                        </small>
                                        <strong class="pull-right primary-font">{{chatMessage.name}}</strong>
                                    </div>
                                    <p>
                                        {{chatMessage.msg}}
                                    </p>
                                </div>
                            </li>                            
                        </ul>
                    </div>
                    <div class="panel-footer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="fa fa-user"></i></span>
                            <input id="btn-input" type="text" class="form-control input-sm" placeholder="Your displayname" ng-model="vm.displayName" />
                        </div>
                        <br/>
                        <div class="input-group">
                            <input id="btn-input" type="text" class="form-control input-sm" placeholder="Type your message here..." ng-model="vm.chatMessage" />
                            <span class="input-group-btn">
                                <button class="btn btn-warning btn-sm" id="btn-chat" ng-click="sendMessage()">
                                    Send
                                </button>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var myapp = angular.module('myapp', ['SignalR', 'ui.bootstrap']);

        //定義一個工廠(factory)服務
        myapp.factory('chatHubFactory', ['$rootScope', 'Hub', function ($rootScope, Hub) {
                //宣告hub的連線物件
                var hub = new Hub('chatHub2', {
                    //宣告可以讓Server來呼叫client side的methods
                    listeners: {
                        //'broadcastMessage': function (name, message) {
                        'broadcastMessage': function (chatMsg) {
                            if (!$rootScope.chatMessages) {
                                $rootScope.chatMessages = [];
                            }
                            $rootScope.chatMessages.push(
                                { name: chatMsg.Name, msg: chatMsg.Message, sendDate: new Date(chatMsg.SubmitDate) }
                            );
                            $rootScope.$apply();
                        }
                    },
                    //宣告server side hub的methods
                    methods: ['Send'],
                    //handle connection error
                    errorHandler: function (error) {
                        console.error(error);
                    }
                });

                var sendMessageToServer = function (name, message) {
                    hub.Send({ name: name, message: message, submitdate: new Date() }); //呼叫Sever的method
                };
                //回傳一個javascript物件裡面包含了一個可以用來
                //送出Chat Message的方法(Method)
                return {
                    sendMessage: sendMessageToServer
                };
        }]);

        //定義一個Controller
        myapp.controller('myappCtrl', function ($scope, chatHubFactory, $rootScope) {
            $scope.vm = {};
            $scope.vm.displayName = '';
            $scope.vm.chatMessage = '';

            $scope.sendMessage = function () {
                if (!$rootScope.chatMessages) {
                    $rootScope.chatMessages = [];
                }

                $rootScope.chatMessages.push({ name: $scope.vm.displayName, msg: $scope.vm.chatMessage, sendDate: new Date(), me: true });
                chatHubFactory.sendMessage($scope.vm.displayName, $scope.vm.chatMessage);
            }

            $scope.closeAlert = function (index) {
                $rootScope.chatMessages.splice(index, 1);
            };
        });
    </script>
</body>
</html>
